{% extends 'detalle_base.html' %}
{% load static %}
{% load user_groups %}
{% load dict_extras %}

{% block title %}Detalle del Inmueble - {{ inmueble.nombre }}{% endblock %}

{% block carrusel_imagenes %}
  <div id="inmuebleCarousel" class="carousel slide mb-4 shadow-sm rounded" data-bs-ride="carousel">
    <div class="carousel-inner rounded">
      {% for imagen in inmueble.imagenes.all %}
        <div class="carousel-item {% if forloop.first %}active{% endif %}">
          <img src="{{ imagen.imagen.url }}" class="d-block w-100 img-carrusel-inmueble" alt="{{ inmueble.nombre }}">
        </div>
      {% empty %}
        <div class="carousel-item active">
          <img src="{% static 'img/default-property-large.jpg' %}" class="d-block w-100 img-carrusel-inmueble" alt="Imagen por defecto">
        </div>
      {% endfor %}
    </div>
    {% if inmueble.imagenes.count > 1 %}
      <button class="carousel-control-prev" type="button" data-bs-target="#inmuebleCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#inmuebleCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    {% endif %}
  </div>
{% endblock %}

{% block info_detallada %}
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h1 class="h2 mb-3">{{ inmueble.nombre }}</h1>
      <div class="d-flex align-items-center mb-3">
        <i class="bi bi-geo-alt-fill text-primary me-2"></i>
        <span class="text-muted">
          {{ inmueble.provincia.nombre }}, {{ inmueble.ciudad.nombre }}, {{ inmueble.direccion }}
        </span>
      </div>
      <div class="d-flex flex-wrap gap-3 mb-4">
        <div class="d-flex align-items-center">
          <i class="bi bi-person text-primary me-2"></i>
          <span>Máx. {{ inmueble.cantidad_huespedes }} huésped{{ inmueble.cantidad_huespedes|pluralize }}</span>
        </div>
        <p class="text-muted small mt-2">
          <i class="bi bi-calendar-date me-1"></i>
          Publicado el {{ inmueble.fecha_publicacion|date:"d/m/Y" }}
        </p>
        {% if inmueble.estado %}
        <span class="badge bg-{% if inmueble.estado.nombre == 'Disponible' %}success{% else %}warning{% endif %}">
          {{ inmueble.estado.nombre }}
        </span>
        {% endif %}
      </div>
      <h3 class="h4 mb-3">Descripción</h3>
      <p class="mb-4">{{ inmueble.descripcion }}</p>
      <h3 class="h4 mb-3">Política de cancelación</h3>
      <p>{{ inmueble.politica_cancelacion }}</p>
    </div>
  </div>
{% endblock %}

{% block sidebar_reserva_o_admin %}
  <div class="card shadow-sm sticky-top" style="top: 20px;">
    <div class="card-body">
      {% if is_admin_or_empleado %}
        <h3 class="h4 mb-3">Gestión del Inmueble</h3>
        <div class="d-flex align-items-end mb-3">
          <span class="h3 text-primary">${{ inmueble.precio_por_dia|floatformat:"0" }}</span>
          <span class="text-muted ms-1">/ noche</span>
        </div>
        {% comment %} 
        <div class="d-grid gap-2 mb-3">
          <a href="{% url 'admin_inmuebles_reservas' id_inmueble=inmueble.id_inmueble %}" class="btn btn-primary">
            <i class="bi bi-calendar-check me-2"></i> Ver Reservas
          </a>
          <a href="{% url 'admin_inmuebles_historial' id_inmueble=inmueble.id_inmueble %}" class="btn btn-secondary">
            <i class="bi bi-clock-history me-2"></i> Ver Historial
          </a>
          {% if is_admin %}
          <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-delete-url="{% url 'admin_inmuebles_eliminar' id_inmueble=inmueble.id_inmueble %}">
            <i class="bi bi-trash me-2"></i> Eliminar inmueble
          </button>
          <a href="{% url 'admin_inmuebles_editar' id_inmueble=inmueble.id_inmueble %}" class="btn btn-warning">
            <i class="bi bi-pencil-square me-2"></i> Editar inmueble
          </a>
          {% endif %}
        </div> 
        {% endcomment %}
      {% else %}
        <h3 class="h4 mb-3">Reservar</h3>
        <div class="d-flex align-items-end mb-3">
          <span class="h3 text-primary">${{ inmueble.precio_por_dia|floatformat:"0" }}</span>
          <span class="text-muted ms-1">/ noche</span>
        </div>

        <form method="post" action="{% url 'crear_reserva' id_inmueble=inmueble.id_inmueble %}">
          {% csrf_token %}
          <div class="mb-3">
            <label for="fecha_inicio" class="form-label">Fecha de llegada</label>
            <input type="text" class="form-control" id="fecha_inicio" name="fecha_inicio" required autocomplete="off">
          </div>
          <div class="mb-3">
            <label for="fecha_fin" class="form-label">Fecha de salida</label>
            <input type="text" class="form-control" id="fecha_fin" name="fecha_fin" required autocomplete="off">
          </div>
          <div class="mb-3">
            <label for="cantidad_adultos" class="form-label">Cantidad de adultos</label>
            <input type="number" class="form-control" id="cantidad_adultos" name="cantidad_adultos" min="1" max="{{ inmueble.cantidad_huespedes }}" required>
          </div>
          <div class="mb-3">
            <label for="cantidad_ninos" class="form-label">Cantidad de niños</label>
            <input type="number" class="form-control" id="cantidad_ninos" name="cantidad_ninos" min="0" max="{{ inmueble.cantidad_huespedes }}" required>
          </div>
          {% comment %} 
          <div class="mb-3">
            <ul id="lista-huespedes" class="list-group mb-2" data-max-huespedes="{{ inmueble.cantidad_huespedes }}"></ul>
            <button type="button" class="btn btn-outline-primary btn-sm w-100" id="btn-agregar-huesped">
              <i class="bi bi-person-plus"></i> Agregar huésped
            </button>
          </div>
          <div id="form-huesped" class="card card-body mb-3" style="display:none; max-width: 500px;">
            <div class="mb-3">
              <label for="huesped-nombre" class="form-label">Nombre</label>
              <input type="text" class="form-control" id="huesped-nombre" placeholder="Nombre">
            </div>
            <div class="mb-3">
              <label for="huesped-apellido" class="form-label">Apellido</label>
              <input type="text" class="form-control" id="huesped-apellido" placeholder="Apellido">
            </div>
            <div class="mb-3">
              <label for="huesped-dni" class="form-label">DNI</label>
              <input type="text" class="form-control" id="huesped-dni" placeholder="DNI">
            </div>
            <div class="mb-3">
              <label for="huesped-fecha-nac" class="form-label">Fecha de nacimiento</label>
              <input type="date" class="form-control" id="huesped-fecha-nac" placeholder="Fecha de nacimiento">
            </div>
            <div class="mt-2 text-end">
              <button type="button" class="btn btn-naranja btn-sm" id="btn-aceptar-huesped">Aceptar</button>
              <button type="button" class="btn btn-azul btn-secondary btn-sm" id="btn-cancelar-huesped">Cancelar</button>
            </div>
          </div>
          <input type="hidden" name="huespedes_json" id="huespedes-json">
          {% endcomment %}
          <button type="submit" class="btn btn-primary btn-azul w-100 py-2">
            <i class="bi bi-calendar-check me-2"></i> Reservar ahora
          </button>
          <div id="django-messages" style="display: none;">
            {% if messages %}
              {% for message in messages %}
                <div class="django-message" data-tags="{{ message.tags }}" data-message="{{ message }}"></div>
              {% endfor %}
            {% endif %}
          </div>
        </form>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block extra_js_custom %}
  <script>
    {% if fecha_fin_mantenimiento %}
      var fechaFinMantenimiento = "{{ fecha_fin_mantenimiento }}";
    {% else %}
      var fechaFinMantenimiento = null;
    {% endif %}

    // JavaScript para establecer la URL de eliminación en el modal común
    document.addEventListener('DOMContentLoaded', function() {
        // Lógica de SweetAlert para mensajes de Django (del detalle_base.js original, pero asegurado aquí)
        const messageElements = document.querySelectorAll('.django-message');
        messageElements.forEach(element => {
          const tags = element.getAttribute('data-tags');
          const message = element.getAttribute('data-message');
          Swal.fire({
            position: 'top-end',
            icon: tags === 'success' ? 'success' : 'error',
            title: message,
            showConfirmButton: false,
            timer: 3000,
            toast: true,
            timerProgressBar: true
          });
        });

        // Lógica de Flatpickr (del detalle_base.js original, pero asegurado aquí)
        const fechasOcupadasJSON = document.getElementById('fechasOcupadasJSON');
        const fechasOcupadasPropiasJSON = document.getElementById('fechasOcupadasPropiasJSON');
        const fechasOcupadas = fechasOcupadasJSON ? JSON.parse(fechasOcupadasJSON.textContent) : [];
        const fechasOcupadasPropias = fechasOcupadasPropiasJSON ? JSON.parse(fechasOcupadasPropiasJSON.textContent) : [];

        function marcarPropias(dayElem) {
            const fechaStr = dayElem.dateObj.toISOString().slice(0, 10);
            if (fechasOcupadasPropias.includes(fechaStr)) {
                dayElem.classList.add('flatpickr-day-propia');
            }
        }

        function getMinDate() {
            if (fechaFinMantenimiento) {
                const fecha = new Date(fechaFinMantenimiento);
                fecha.setDate(fecha.getDate() + 1);
                return fecha.toISOString().slice(0, 10);
            }
            return "today";
        }

        flatpickr("#fecha_inicio", {
            disable: fechasOcupadas,
            dateFormat: "Y-m-d",
            minDate: getMinDate(),
            onDayCreate: function(dObj, dStr, fp, dayElem) {
                marcarPropias(dayElem);
            }
        });

        flatpickr("#fecha_fin", {
            disable: fechasOcupadas,
            dateFormat: "Y-m-d",
            minDate: getMinDate(),
            onDayCreate: function(dObj, dStr, fp, dayElem) {
                marcarPropias(dayElem);
            }
        });
    });
  </script>
{% endblock extra_js_custom %}