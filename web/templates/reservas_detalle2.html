{% extends 'base/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Detalle de Reserva #{{ reserva.id_reserva }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  .bg-azul-alquiler {
    background-color: #005A87 !important;
  }
  .error-message {
    font-size: 0.875rem;
    color: #dc3545;
    margin-top: 0.25rem;
  }
</style>

<div class="container mt-4" style="padding-top: 100px;">
  <div class="card shadow-sm">
    <div class="card-header bg-azul-alquiler text-white">
      <h4 class="mb-0">Reserva #{{ reserva.id_reserva }}</h4>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-9">
          <div class="mb-2">
            <strong>Inmueble:</strong>
            <span class="ms-1">{% if reserva.inmueble %}
                                  {{ reserva.inmueble }}
                                {% elif reserva.cochera %}
                                  {{ reserva.cochera }}
                                {% endif %}
            </span>
          </div>
          <div class="mb-2">
            <strong>Cliente:</strong>
            <span class="ms-1">
              {% with relacion=reserva.clienteinmueble_set.first %}
                {% if relacion and relacion.cliente %}
                  {{ relacion.cliente.usuario.get_full_name|default:relacion.cliente.usuario.username }}
                {% else %}
                  <em>Cliente no disponible</em>
                {% endif %}
              {% endwith %}
            </span>
          </div>
          <div class="mb-2">
            <strong>Fechas:</strong>
            <span class="ms-1">{{ reserva.fecha_inicio|date:"d/m/Y" }} - {{ reserva.fecha_fin|date:"d/m/Y" }}</span>
          </div>
          <div class="mb-2">
            <strong>Precio total:</strong>
            <span class="ms-1">${{ reserva.precio_total }}</span>
          </div>
          <div class="mb-2">
            <strong>Estado:</strong>
            <span class="badge 
              {% if reserva.estado.nombre == 'Confirmada' %}bg-success
              {% elif reserva.estado.nombre == 'Cancelada' %}bg-danger
              {% elif reserva.estado.nombre == 'Rechazada' %}bg-secondary
              {% elif reserva.estado.nombre == 'Pagada' %}bg-info
              {% elif reserva.estado.nombre == 'Aprobada' %}bg-primary
              {% elif reserva.estado.nombre == 'Pendiente' %}bg-warning
              {% elif reserva.estado.nombre == 'Finalizada' %}bg-dark
              {% else %}bg-warning{% endif %}">
              {{ reserva.estado.nombre }}
            </span>
          </div>
        </div>
        <div class="col-md-3 d-flex align-items-center justify-content-md-end justify-content-start mt-3 mt-md-0">
        </div>
      </div>

      <!-- Sección de Huéspedes -->
      {% if reserva.inmueble %}
        <div class="mb-3">
          <strong>Huéspedes:</strong>
          <ul class="list-group mt-2">
            <!-- Mostramos primero al cliente como huésped principal -->
            {% with cliente=reserva.clienteinmueble_set.first.cliente %}
              <li class="list-group-item">
                <div class="d-flex align-items-center flex-wrap gap-3">
                  <span class="me-2">
                    <i class="bi bi-person-fill text-primary fs-4"></i>
                  </span>
                  <span class="fw-semibold">{{ cliente.usuario.first_name }} {{ cliente.usuario.last_name }}</span>
                  <span class="badge bg-light text-dark border fw-normal">
                    DNI: <span class="fw-semibold">{{ cliente.dni }}</span>
                  </span>
                  <span class="badge bg-light text-dark border fw-normal">
                    Nacimiento: <span class="fw-semibold">{{ cliente.fecha_nacimiento|date:"d/m/Y" }}</span>
                  </span>
                  <span class="badge bg-primary text-white">
                    Titular
                  </span>
                </div>
            {% endwith %}

            {% if reserva.estado.nombre == "Pendiente" %}
              <li class="list-group-item text-muted p-3">
                Al confirmarse la reserva se le pedirá cargar los datos de los demás husepedes
              </li>
            {% endif %}

            <!-- Mostramos el resto de huéspedes adicionales -->
            {% for h in huespedes %}
              <li class="list-group-item">
                <div class="d-flex align-items-center flex-wrap gap-3">
                  <span class="me-2">
                    <i class="bi bi-person-fill text-primary fs-4"></i>
                  </span>
                  <span class="fw-semibold">{{ h.nombre }} {{ h.apellido }}</span>
                  <span class="badge bg-light text-dark border fw-normal">
                    DNI: <span class="fw-semibold">{{ h.dni }}</span>
                  </span>
                  <span class="badge bg-light text-dark border fw-normal">
                    Nacimiento: <span class="fw-semibold">{{ h.fecha_nacimiento|date:"d/m/Y" }}</span>
                  </span>
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <!-- Formulario de Reservas -->
      {% if reserva.inmueble and reserva.estado.nombre == "Aprobada" %}
        {% with total_huespedes=huespedes|length|add:1 %}
          {% if total_huespedes < reserva.cantidad_adultos|add:reserva.cantidad_ninos %}
            <form id="form-huespedes" method="POST" action="{% url 'completar_huespedes' id_reserva=reserva.id_reserva %}">
              {% csrf_token %}

              <!-- Adultos adicionales -->
              {% with adultos_restantes=reserva.cantidad_adultos|add:-1 %}
                {% if adultos_restantes > 0 %}
                  <h6>Adultos adicionales ({{ adultos_restantes }})</h6>
                  {% for i in rango_adultos %}
                    {% if forloop.counter0 < adultos_restantes %}
                      <div class="row mb-2">
                        <div class="col-md-3">
                          {% with clave='nombre_'|add:forloop.counter0 %}
                            <input type="text" name="nombre_{{ forloop.counter0 }}" class="form-control"
                                  placeholder="Nombre" required
                                  value="{{ huespedes_precargados|get_item:clave }}">
                          {% endwith %}
                        </div>
                        <div class="col-md-3">
                          {% with clave='apellido_'|add:forloop.counter0 %}
                            <input type="text" name="apellido_{{ forloop.counter0 }}" class="form-control"
                                  placeholder="Apellido" required
                                  value="{{ huespedes_precargados|get_item:clave }}">
                          {% endwith %}
                        </div>
                        <div class="col-md-3">
                          {% with clave='dni_'|add:forloop.counter0 %}
                            <input type="number" name="dni_{{ forloop.counter0 }}" class="form-control"
                                  placeholder="DNI" required
                                  value="{{ huespedes_precargados|get_item:clave }}">
                          {% endwith %}
                        </div>
                        <div class="col-md-3">
                          {% with clave='fecha_nacimiento_'|add:forloop.counter0 %}
                            <input type="date" name="fecha_nacimiento_{{ forloop.counter0 }}"
                                  class="form-control fecha-adulto" required
                                  value="{{ huespedes_precargados|get_item:clave }}">
                            <small class="text-muted">Debe ser mayor de 18 años</small>
                          {% endwith %}
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endwith %}

              <!-- Niños -->
              {% if reserva.cantidad_ninos > 0 %}
                <h6>Niños ({{ reserva.cantidad_ninos }})</h6>
                {% for i in rango_ninos %}
                  {% with index=forloop.counter0|add:reserva.cantidad_adultos %}
                    <div class="row mb-2">
                      <div class="col-md-3">
                        {% with clave='nombre_'|add:index %}
                          <input type="text" name="nombre_{{ index }}" class="form-control"
                                placeholder="Nombre" required
                                value="{{ huespedes_precargados|get_item:clave }}">
                        {% endwith %}
                      </div>
                      <div class="col-md-3">
                        {% with clave='apellido_'|add:index %}
                          <input type="text" name="apellido_{{ index }}" class="form-control"
                                placeholder="Apellido" required
                                value="{{ huespedes_precargados|get_item:clave }}">
                        {% endwith %}
                      </div>
                      <div class="col-md-3">
                        {% with clave='dni_'|add:index %}
                          <input type="number" name="dni_{{ index }}" class="form-control"
                                placeholder="DNI" required
                                value="{{ huespedes_precargados|get_item:clave }}">
                        {% endwith %}
                      </div>
                      <div class="col-md-3">
                        {% with clave='fecha_nacimiento_'|add:index %}
                          <input type="date" name="fecha_nacimiento_{{ index }}" class="form-control fecha-nino" required
                                value="{{ huespedes_precargados|get_item:clave }}">
                        {% endwith %}
                      </div>
                    </div>
                  {% endwith %}
                {% endfor %}
              {% endif %}

              <button type="submit" class="btn btn-primary mt-3">
                <i class="bi bi-save me-1"></i> Guardar huéspedes
              </button>
            </form>
          {% endif %}
        {% endwith %}
      {% endif %}


      <!-- Botones de acción -->
      <div class="mt-4 d-flex flex-wrap gap-2 align-items-center">
        {% if reserva.estado.nombre != "Cancelada" and reserva.estado.nombre != "Finalizada" %}
          {% if reserva.estado.nombre == "Confirmada" %}
            {% if tiempo_restante and tiempo_restante > 0 %}
              <div class="alert alert-info d-flex align-items-center gap-2 mb-0 rounded-pill shadow-sm border-0 py-2 px-3" id="timer-pago" style="background: #e3f6fd; font-size: 1rem;">
                <i class="bi bi-clock-history text-primary" style="font-size: 1.2rem;"></i>
                <span class="fw-semibold">
                  <span class="d-none d-md-inline">Tiempo restante para pagar:</span>
                  <span id="timer" class="ms-1 text-dark" style="font-family: monospace; font-size: 1.1rem;"></span>
                </span>
              </div>
              
              {% if is_client %}
                {% if huespedes|length == reserva.cantidad_adultos|add:reserva.cantidad_ninos %}
                  <button class="btn btn-success d-flex align-items-center h-100" id="pagar-btn">
                    <i class="bi bi-cash-coin me-1"></i> Pagar
                  </button>
                {% else %}
                  <button class="btn btn-secondary d-flex align-items-center h-100" disabled>
                    <i class="bi bi-cash-coin me-1"></i> Pagar
                  </button>
                  <div class="text-danger small ms-2">
                    Complete los datos de todos los huéspedes para habilitar el pago
                  </div>
                {% endif %}
              {% endif %}
            {% else %}
              <div class="alert alert-danger d-flex align-items-center gap-2 mb-3">
                <i class="bi bi-clock-history fs-5"></i>
                <span>El tiempo para pagar la reserva ha expirado.</span>
              </div>
            {% endif %}
          {% endif %}
          
          {% if not is_admin_or_empleado and tiempo_restante and tiempo_restante > 0 %}
            <form id="cancelarReservaForm" method="post" action="{% url 'cancelar_reserva' reserva.id_reserva %}" class="m-0">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger d-flex align-items-center h-100">
                <i class="bi bi-x-circle me-1"></i> Cancelar reserva
              </button>
            </form>
          {% endif %}
        {% endif %}
      </div>
      <br>
      {% if reserva.inmueble %}
        {% with total_huespedes=huespedes|length %}
          {% if total_huespedes < reserva.cantidad_adultos|add:reserva.cantidad_ninos %}
            <form id="form-huespedes" method="post" action="{% url 'completar_huespedes' reserva.id_reserva %}">
              {% csrf_token %}
              <h5>Completa los datos de los huéspedes antes de pagar</h5>
              <h6> Adultos </h6>
              {% for i in rango_adultos %}
                <div class="row mb-2">
                  <div class="col">
                    <input type="text" name="nombre_{{ forloop.counter0 }}" class="form-control" placeholder="Nombre" required>
                  </div>
                  <div class="col">
                    <input type="text" name="apellido_{{ forloop.counter0 }}" class="form-control" placeholder="Apellido" required>
                  </div>
                  <div class="col">
                    <input type="text" name="dni_{{ forloop.counter0 }}" class="form-control" placeholder="DNI" required>
                  </div>
                  <div class="col">
                    <input type="text" name="fecha_nacimiento_{{ forloop.counter0 }}" class="form-control fecha-adulto" required>
                    <small class="text-muted">Debe ser mayor de 18 años</small>
                  </div>
                </div>
              {% endfor %}
              {% if reserva.cantidad_ninos > 0 %}
                <h6> Niños </h6>
                {% for i in rango_ninos %}
                  <div class="row mb-2">
                    <div class="col">
                      <input type="text" name="nombre_{{ forloop.counter0|add:reserva.cantidad_adultos }}" class="form-control" placeholder="Nombre" required>
                    </div>
                    <div class="col">
                      <input type="text" name="apellido_{{ forloop.counter0|add:reserva.cantidad_adultos }}" class="form-control" placeholder="Apellido" required>
                    </div>
                    <div class="col">
                      <input type="text" name="dni_{{ forloop.counter0|add:reserva.cantidad_adultos }}" class="form-control" placeholder="DNI" required>
                    </div>
                    <div class="col">
                      <input type="date" name="fecha_nacimiento_{{ forloop.counter0|add:reserva.cantidad_adultos }}" class="form-control fecha-nino" required>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}
              <button type="submit" class="btn btn-primary">Guardar huéspedes</button>
            </form>
          {% endif %}
        {% endwith %}
      {% endif %}

      {% if reserva.cochera %}
        <div class="mb-3">
          {% if reserva.patente %}
            <div class="mt-2">
              <strong>Patente registrada:</strong> {{ reserva.patente }}
            </div>
          {% else %}
            <form method="post" action="{% url 'guardar_patente' reserva.id_reserva %}" class="row g-2 align-items-end" id="form-patente">
              {% csrf_token %}
              <div class="col-auto">
                <label for="patente" class="form-label mb-0">Patente del vehículo</label>
                <input type="text" class="form-control" id="patente" name="patente" required maxlength="10" placeholder="ABC123 o AA123BB"
                      value="{{ reserva.patente|default_if_none:'' }}">
              </div>
              <div class="col-auto">
                <button type="submit" class="btn btn-primary">Guardar patente</button>
              </div>
            </form>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  // Timer de pago
  {% if tiempo_restante and tiempo_restante > 0 %}
    console.log('Tiempo restante:', "{{ tiempo_restante|floatformat:0 }}");
    let tiempo = Number("{{ tiempo_restante|floatformat:0 }}");
    function actualizarTimer() {
      if (tiempo <= 0) {
        document.getElementById('timer').innerText = "Tiempo agotado";
        const btn = document.getElementById('pagar-btn');
        if (btn) {
          btn.classList.add('disabled');
          btn.setAttribute('aria-disabled', 'true');
          btn.onclick = function(e){ e.preventDefault(); };
        }
        return;
      }
      let horas = Math.floor(tiempo / 3600);
      let minutos = Math.floor((tiempo % 3600) / 60);
      let segundos = Math.floor(tiempo % 60);
      document.getElementById('timer').innerText =
        `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
      tiempo--;
      setTimeout(actualizarTimer, 1000);
    }
    actualizarTimer();
  {% endif %}

  document.addEventListener('DOMContentLoaded', function() {

    // Cancelar reserva
    const cancelarForm = document.getElementById('cancelarReservaForm');
    if (cancelarForm) {
      cancelarForm.addEventListener('submit', function(e) {
        e.preventDefault();
        Swal.fire({
          title: '¿Seguro que deseas cancelar la reserva?',
          text: "Esta acción no se puede deshacer.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Sí, cancelar',
          cancelButtonText: 'No, volver'
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(this.action, {
              method: 'POST',
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
              }
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'Cancelada',
                  text: data.mensaje,
                  timer: 2500,
                  timerProgressBar: true,
                  showConfirmButton: false
                }).then(() => {
                  window.location.href = "{% url 'reservas_usuario' %}";
                });
              }
            });
          }
        });
      });
    }

    // Pago con MercadoPago
    const pagarBtn = document.getElementById('pagar-btn');
    if (pagarBtn) {
      pagarBtn.addEventListener('click', function() {
        fetch("{% url 'crear_preferencia_mp' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
          },
          body: JSON.stringify({
              monto: {{ reserva.precio_total }},
              descripcion: "Pago de reserva #{{ reserva.id_reserva }}",
              id_reserva: {{ reserva.id_reserva }}
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.init_point) {
            window.location.href = data.init_point;
          } else {
              Swal.fire({
              icon: 'error',
              title: 'Error',
              text: "Error al generar el pago: " + (data.error || "Error desconocido"),
              timer: 3000,
              timerProgressBar: true,
              showConfirmButton: false
              });
          }
        });
      });
    }

    // Datepickers para fechas de nacimiento
    const hoy = new Date();
    const fechaMaxAdulto = new Date(hoy.getFullYear() - 18, hoy.getMonth(), hoy.getDate());
    const fechaMinNino = new Date(hoy.getFullYear() - 18, hoy.getMonth(), hoy.getDate() + 1);

    flatpickr('.fecha-adulto', {
      dateFormat: "Y-m-d",
      maxDate: fechaMaxAdulto,
      locale: "es",
      allowInput: true,
      disableMobile: true,
      onReady: function(selectedDates, dateStr, instance) {
        instance.element.value = dateStr;
      }
    });

    flatpickr('.fecha-nino', {
      dateFormat: "Y-m-d",
      minDate: fechaMinNino,
      maxDate: hoy,
      locale: "es",
      allowInput: true,
      disableMobile: true,
      onReady: function(selectedDates, dateStr, instance) {
        instance.element.value = dateStr;
      }
    });

    // Formulario de huéspedes
    const formHuespedes = document.getElementById('form-huespedes');
    if (formHuespedes) {
      formHuespedes.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(formHuespedes);

        // Limpiar errores anteriores
        document.querySelectorAll('.error-message').forEach(el => el.remove());

        fetch(formHuespedes.action, {
          method: 'POST',
          headers: {
            'X-CSRFToken': formHuespedes.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Éxito - recargar página
            window.location.reload();
          } else {
            // Mostrar errores debajo de cada campo
            if (data.errors) {
              Object.entries(data.errors).forEach(([field, error]) => {
                const input = document.querySelector(`[name="${field}"]`);
                if (input && !input.parentNode.querySelector('.error-message')) {
                  const errorElement = document.createElement('div');
                  errorElement.className = 'error-message text-danger small mt-1';
                  errorElement.textContent = error;
                  input.parentNode.appendChild(errorElement);
                }
              });
            }

            // Repoblar los campos con los datos enviados (por si el navegador no los mantuvo)
            if (data.huespedes_data) {
              data.huespedes_data.forEach((huesped, index) => {
                const nombreInput = document.querySelector(`input[name="nombre_${index}"]`);
                const apellidoInput = document.querySelector(`input[name="apellido_${index}"]`);
                const dniInput = document.querySelector(`input[name="dni_${index}"]`);
                const fechaInput = document.querySelector(`input[name="fecha_nacimiento_${index}"]`);

                if (nombreInput) nombreInput.value = huesped.nombre || '';
                if (apellidoInput) apellidoInput.value = huesped.apellido || '';
                if (dniInput) dniInput.value = huesped.dni || '';
                if (fechaInput) fechaInput.value = huesped.fecha_nacimiento || '';
              });
            }
          }
        });
      });

      // Limpiar error al tipear en cada input
      formHuespedes.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', function() {
          const error = this.parentNode.querySelector('.error-message');
          if (error) error.remove();
        });
      });
    }

  });
</script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Cargando script de formulario de patente');
      const form_patente = document.getElementById('form-patente');
      if (form_patente) {
        form_patente.addEventListener('submit', function(e) {
          e.preventDefault();
          const formData = new FormData(form_patente);
          fetch(form_patente.action, {
            method: 'POST',
            headers: {
              'X-CSRFToken': form_patente.querySelector('[name=csrfmiddlewaretoken]').value,
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              Swal.fire({
                icon: 'success',
                title: data.message || 'Patente guardada correctamente.',
                toast: true,
                position: 'top-end',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
              }).then(() => {
                window.location.reload();
              });
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.error || 'Ocurrió un error al guardar la patente.',
                toast: true,
                position: 'top-end',
                timer: 4000,
                timerProgressBar: true,
                showConfirmButton: false
              });
            }
          })
          .catch(err => {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Ocurrió un error al procesar la solicitud.',
              toast: true,
              position: 'top-end',
              timer: 3000,
              timerProgressBar: true,
              showConfirmButton: false
            });
          });
        });
      }
    });
  </script>
  
{% endblock %}


@login_required
@require_POST
def completar_huespedes(request, id_reserva):
    reserva = get_object_or_404(Reserva, id_reserva=id_reserva)
    total = reserva.cantidad_adultos + reserva.cantidad_ninos

    huespedes_data = []
    errores_dict = {}
    dnis = set()

    for i in range(total):
        nombre = request.POST.get(f'nombre_{i}', '').strip()
        apellido = request.POST.get(f'apellido_{i}', '').strip()
        dni = request.POST.get(f'dni_{i}', '').strip()
        fecha_nacimiento = request.POST.get(f'fecha_nacimiento_{i}', '').strip()

        # Validar fecha nacimiento
        try:
            fecha_obj = datetime.strptime(fecha_nacimiento, '%Y-%m-%d').date()
        except ValueError:
            errores_dict[f'fecha_nacimiento_{i}'] = "Fecha de nacimiento inválida."
            fecha_obj = None

        huespedes_data.append({
            'nombre': nombre,
            'apellido': apellido,
            'dni': dni,
            'fecha_nacimiento': fecha_nacimiento,
            'fecha_obj': fecha_obj
        })

        # Validaciones DNI
        if not dni.isdigit():
            errores_dict[f'dni_{i}'] = "El DNI debe contener solo números."
        elif len(dni) not in [7, 8]:
            errores_dict[f'dni_{i}'] = "El DNI debe tener 7 u 8 dígitos."
        elif dni in dnis:
            errores_dict[f'dni_{i}'] = "Este DNI está repetido."
        elif Huesped.objects.filter(reserva=reserva, dni=dni).exists():
            errores_dict[f'dni_{i}'] = "Este DNI ya está registrado para esta reserva."
        else:
            dnis.add(dni)
            if any(char.isdigit() for char in nombre):
                errores.append(f"El nombre '{nombre}' no puede contener números.")
            if any(char.isdigit() for char in apellido):
                errores.append(f"El apellido '{apellido}' no puede contener números.")
            if not dni.isdigit():
                errores.append(f"El DNI '{dni}' debe contener solo números.")

        if errores:
            if request.headers.get('x-requested-with') == 'XMLHttpRequest':
                return JsonResponse({'success': False, 'errors': errores})
            for error in errores:
                messages.error(request, error)
            return redirect('ver_detalle_reserva', id_reserva=id_reserva)

        # Guardar huéspedes...
        for i in range(total):
            nombre = request.POST.get(f'nombre_{i}', '').strip()
            apellido = request.POST.get(f'apellido_{i}', '').strip()
            dni = request.POST.get(f'dni_{i}', '').strip()
            fecha_nacimiento = request.POST.get(f'fecha_nacimiento_{i}', '').strip()
            Huesped.objects.create(
                reserva=reserva,
                nombre=nombre,
                apellido=apellido,
                dni=dni,
                fecha_nacimiento=fecha_nacimiento
            )
        if request.headers.get('x-requested-with') == 'XMLHttpRequest':
            return JsonResponse({'success': True, 'message': 'Huéspedes cargados correctamente.'})
        messages.success(request, "Huéspedes cargados correctamente.")
        return redirect('ver_detalle_reserva', id_reserva=id_reserva)