{% extends 'detalle_base.html' %}
{% load static %}
{% load user_groups %}
{% load dict_extras %}

{% block title %}Detalle de la Cochera - {{ cochera.nombre }}{% endblock %}

{% block carrusel_imagenes %}
  <div id="cocheraCarousel" class="carousel slide mb-4 shadow-sm rounded" data-bs-ride="carousel">
    <div class="carousel-inner rounded">
      {% for imagen in cochera.imagenes.all %}
        <div class="carousel-item {% if forloop.first %}active{% endif %}">
          <img src="{{ imagen.imagen.url }}" class="d-block w-100 cochera-hero-img" alt="{{ cochera.nombre }}">
        </div>
      {% empty %}
        <div class="carousel-item active">
          <img src="{% static 'img/default-garage-large.jpg' %}" class="d-block w-100 cochera-hero-img" alt="Imagen por defecto">
        </div>
      {% endfor %}
    </div>
    {% if cochera.imagenes.count > 1 %}
      <button class="carousel-control-prev" type="button" data-bs-target="#cocheraCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#cocheraCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    {% endif %}
  </div>
{% endblock %}

{% block info_detallada %}
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h1 class="h2 mb-3">{{ cochera.nombre }}</h1>
      <div class="d-flex align-items-center mb-3">
        <i class="bi bi-geo-alt-fill text-primary me-2"></i>
        <span class="text-muted">
          {{ cochera.provincia.nombre }}, {{ cochera.ciudad.nombre }}, {{ cochera.direccion }}
        </span>
      </div>
      <div class="d-flex flex-wrap gap-3 mb-4">
        <div class="d-flex align-items-center">
          <i class="bi bi-car-front text-primary me-2"></i>
          <span>{{ cochera.cantidad_vehiculos }} vehículo{{ cochera.cantidad_vehiculos|pluralize }}</span>
        </div>
        <div class="d-flex align-items-center">
          <i class="bi bi-arrows-angle-expand text-primary me-2"></i>
          <span>{{ cochera.ancho }}m × {{ cochera.largo }}m × {{ cochera.alto }}m</span>
        </div>
        <div class="d-flex align-items-center">
          <i class="bi bi-building text-primary me-2"></i>
          <span>Techo: {{ cochera.con_techo|yesno:"Sí,No" }}</span>
        </div>
        <div class="d-flex align-items-center">
          <i class="bi bi-calendar-range text-primary me-2"></i>
          <span>Mínimo {{ cochera.minimo_dias_alquiler }} noche{{ cochera.minimo_dias_alquiler|pluralize }}</span>
        </div>
        <p class="text-muted small mt-2">
          <i class="bi bi-calendar-date me-1"></i>
          Publicado el {{ cochera.fecha_publicacion|date:"d/m/Y" }}
        </p>
        {% if cochera.estado %}
        <span class="badge bg-{% if cochera.estado.nombre == 'Disponible' %}success{% else %}warning{% endif %}">
          {{ cochera.estado.nombre }}
        </span>
        {% endif %}
      </div>
      <h3 class="h4 mb-3">Descripción</h3>
      <p class="mb-4">{{ cochera.descripcion }}</p>
      <h3 class="h4 mb-3">Política de cancelación</h3>
      <p>{{ cochera.politica_cancelacion }}</p>
    </div>
  </div>
{% endblock %}

{% block sidebar_reserva_o_admin %}
  <div class="card shadow-sm sticky-top" style="top: 20px;">
    <div class="card-body">
      {% if is_admin_or_empleado %}
        <h3 class="h4 mb-3">Gestión de la Cochera</h3>
        <div class="d-flex align-items-end mb-3">
          <span class="h3 text-primary">${{ cochera.precio_por_dia|floatformat:"0" }}</span>
          <span class="text-muted ms-1">/ día</span>
        </div>
      {% else %}
        <h3 class="h4 mb-3">Reservar</h3>
        <div class="d-flex align-items-end mb-3">
          <span class="h3 text-primary">${{ cochera.precio_por_dia|floatformat:"0" }}</span>
          <span class="text-muted ms-1">/ noche</span>
        </div>
        <form method="post" action="{% url 'crear_reserva_cochera' id_cochera=cochera.id_cochera %}">
          {% csrf_token %}
          <div class="mb-3">
            <label for="fecha_inicio" class="form-label">Fecha de llegada</label>
            <input type="text" class="form-control" id="fecha_inicio" name="fecha_inicio" required autocomplete="off">
          </div>
          <div class="mb-3">
            <label for="fecha_fin" class="form-label">Fecha de salida</label>
            <input type="text" class="form-control" id="fecha_fin" name="fecha_fin" required autocomplete="off">
          </div>
          <button type="submit" class="btn btn-primary btn-azul w-100 py-2">
            <i class="bi bi-calendar-check me-2"></i> Reservar ahora
          </button>
          <div id="django-messages" style="display: none;">
            {% if messages %}
              {% for message in messages %}
                <div class="django-message" data-tags="{{ message.tags }}" data-message="{{ message }}"></div>
              {% endfor %}
            {% endif %}
          </div>
        </form>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block modal_eliminar %}
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          ¿Estás seguro de que quieres eliminar la cochera "{{ cochera.nombre }}"? Esta acción no se puede deshacer.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <form method="post" action="{% url 'admin_cocheras_eliminar' id_cochera=cochera.id_cochera %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Eliminar</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</main>

{% if not user.is_authenticated %}
  <!-- Cartelito para autenticarte -->
  <section class="container mt-5">
    <div class="card shadow-sm border-0 text-center py-4 mb-5">
      <div class="card-body">
        <i class="bi bi-lock-fill display-4 text-muted mb-3"></i>
        <h3 class="h4 mb-3">Iniciá sesión para dejar tu reseña o comentario</h3>
        <p class="mb-4">Compartí tu experiencia con este alojamiento</p>
        <div class="d-flex justify-content-center gap-3">
          <a href="{% url 'login' %}" class="btn btn-primary btn-azul">
            Iniciar sesión
          </a>
          <a href="{% url 'register' %}" class="btn btn-outline-primary">
            Registrarse
          </a>
        </div>
      </div>
    </div>
  </section>
{% endif %}
  {% include '_comentarios.html' %}
  {% include '_resenias.html' %}
{% endblock %}

{# No need for an extra_js block here, as the common JS is in detalle_base.html #}