{% extends 'base/base.html' %}
{% load static %}

{% block title %}Detalle de Reserva #{{ reserva.id_reserva }}{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block content %}
<style>
  .bg-azul-alquiler {
    background-color: #005A87 !important;
  }
</style>
<div class="container mt-4" style="padding-top: 100px;">
  <div class="card shadow-sm">
    <div class="card-header bg-azul-alquiler text-white">
      <h4 class="mb-0">Reserva #{{ reserva.id_reserva }}</h4>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-9">
          <div class="mb-2">
            <strong>Inmueble:</strong>
            <span class="ms-1">{% if reserva.inmueble %}
                                  {{ reserva.inmueble }}
                                {% elif reserva.cochera %}
                                  {{ reserva.cochera }}
                                {% endif %}
            </span>
          </div>
          <div class="mb-2">
            <strong>Cliente:</strong>
            <span class="ms-1">
              {% with relacion=reserva.clienteinmueble_set.first %}
                {% if relacion and relacion.cliente %}
                  {{ relacion.cliente.usuario.get_full_name|default:relacion.cliente.usuario.username }}
                {% else %}
                  <em>Cliente no disponible</em>
                {% endif %}
              {% endwith %}
            </span>
          </div>
          <div class="mb-2">
            <strong>Fechas:</strong>
            <span class="ms-1">{{ reserva.fecha_inicio|date:"d/m/Y" }} - {{ reserva.fecha_fin|date:"d/m/Y" }}</span>
          </div>
          <div class="mb-2">
            <strong>Precio total:</strong>
            <span class="ms-1">${{ reserva.precio_total }}</span>
          </div>
          <div class="mb-2">
            <strong>Estado:</strong>
            <span class="badge 
              {% if reserva.estado.nombre == 'Confirmada' %}bg-success
              {% elif reserva.estado.nombre == 'Cancelada' %}bg-danger
              {% elif reserva.estado.nombre == 'Rechazada' %}bg-secondary
              {% elif reserva.estado.nombre == 'Pagada' %}bg-info
              {% elif reserva.estado.nombre == 'Aprobada' %}bg-primary
              {% elif reserva.estado.nombre == 'Pendiente' %}bg-warning
              {% elif reserva.estado.nombre == 'Finalizada' %}bg-dark
              {% else %}bg-warning{% endif %}">
              {{ reserva.estado.nombre }}
            </span>
          </div>
          
          <!-- Contador de 72 horas desde creación -->
          {% if reserva.estado.nombre == "Pendiente" and tiempo_restante_creacion is not None %}
            <div class="mb-2">
              <strong>Tiempo para revisión:</strong>
              {% if tiempo_restante_creacion > 0 %}
                <div class="alert alert-warning d-flex align-items-center gap-2 mb-0 mt-1 py-2 px-3" style="background: #fff3cd;">
                  <i class="bi bi-clock-history text-warning"></i>
                  <span class="fw-semibold">
                    Tiempo restante: <span id="timer-creacion" class="text-dark" style="font-family: monospace;"></span>
                  </span>
                </div>
              {% else %}
                <div class="alert alert-danger d-flex align-items-center gap-2 mb-0 mt-1 py-2 px-3">
                  <i class="bi bi-exclamation-triangle"></i>
                  <span>Las 72 horas de revisión han expirado.</span>
                </div>
              {% endif %}
            </div>
          {% endif %}
        </div>
        <div class="col-md-3 d-flex align-items-center justify-content-md-end justify-content-start mt-3 mt-md-0">

        </div>
      </div>
      {% if reserva.inmueble %}
        <div class="mb-3">
          <strong>Huéspedes:</strong>
          <ul class="list-group mt-2">
            {% for h in huespedes %}
              <li class="list-group-item">
                <div class="d-flex align-items-center flex-wrap gap-3">
                  <!-- Icono -->
                  <span class="me-2">
                    <i class="bi bi-person-fill {% if forloop.first %}text-primary{% else %}text-secondary{% endif %} fs-4"></i>
                  </span>
                  <!-- Nombre y apellido -->
                  <span class="fw-semibold">
                    {{ h.nombre }} {{ h.apellido }}
                    {% if forloop.first %}
                      <span class="badge bg-primary ms-2">Titular</span>
                    {% endif %}
                  </span>
                  <!-- DNI -->
                  <span class="badge bg-light text-dark border fw-normal">
                    DNI: <span class="fw-semibold">{{ h.dni }}</span>
                  </span>
                  <!-- Fecha de nacimiento -->
                  <span class="badge bg-light text-dark border fw-normal">
                    Nac: <span class="fw-semibold">{{ h.fecha_nacimiento|date:"d/m/Y" }}</span>
                  </span>
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
      {% if not is_admin_or_empleado %}
        <!-- Botones de acción -->
        <div class="mt-4 d-flex flex-wrap gap-2 align-items-center">
          {% if reserva.estado.nombre != "Cancelada" and reserva.estado.nombre != "Finalizada" %}
            {% if reserva.estado.nombre == "Aprobada" %}
              {% if tiempo_restante and tiempo_restante > 0 %}
                <div class="alert alert-info d-flex align-items-center gap-2 mb-0 rounded-pill shadow-sm border-0 py-2 px-3" id="timer-pago" style="background: #e3f6fd; font-size: 1rem;">
                  <i class="bi bi-clock-history text-primary" style="font-size: 1.2rem;"></i>
                  <span class="fw-semibold">
                    <span class="d-none d-md-inline">Tiempo restante para pagar:</span>
                    <span id="timer" class="ms-1 text-dark" style="font-family: monospace; font-size: 1.1rem;"></span>
                  </span>
                </div>
                {% if not is_admin_or_empleado and huespedes|length == reserva.cantidad_adultos|add:reserva.cantidad_ninos or reserva.patente %}
                  <button class="btn btn-success d-flex align-items-center h-100" id="pagar-btn">
                    <i class="bi bi-cash-coin me-1"></i> Pagar
                  </button>
                {% else %}
                  <button class="btn btn-secondary d-flex align-items-center h-100" disabled>
                    <i class="bi bi-cash-coin me-1"></i> Pagar
                  </button>
                {% endif %}
              {% else %}
                <div class="alert alert-danger d-flex align-items-center gap-2 mb-3">
                  <i class="bi bi-clock-history fs-5"></i>
                  <span>El tiempo para pagar la reserva ha expirado.</span>
                </div>
              {% endif %}
            {% endif %}
            {% if not is_admin_or_empleado %}
              <!-- Botón de cancelar ANTES del pago (Pendiente/Aprobada) -->
              {% if tiempo_restante and tiempo_restante > 0 %}
                <form id="cancelarReservaForm" method="post" action="{% url 'cancelar_reserva' reserva.id_reserva %}" class="m-0">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger d-flex align-items-center h-100">
                    <i class="bi bi-x-circle me-1"></i> Cancelar reserva
                  </button>
                </form>
              <!-- Botón de cancelar DESPUÉS del pago (Pagada/Confirmada) -->
              {% elif reserva.estado.nombre in "Pagada,Confirmada" %}
                <form id="cancelarReservaPagadaForm" method="post" action="{% url 'cancelar_reserva' reserva.id_reserva %}" class="m-0">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-warning d-flex align-items-center h-100">
                    <i class="bi bi-exclamation-triangle me-1"></i> Cancelar reserva
                  </button>
                </form>
              {% endif %}
            {% endif %}
          {% endif %}

          <!-- SECCIÓN DE EXTENSIÓN CORREGIDA -->
          {% if reserva.estado.nombre == 'Confirmada' and not is_admin_or_empleado %}
            <div class="card mt-4 shadow-sm border-0" style="border-left: 4px solid #ffc107 !important;">
              <div class="card-body">
                {% if puede_extender %}
                  <!-- Estado: Disponible (más de 24 horas restantes) -->
                  <div class="alert alert-success border-0 mb-3" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-check-circle-fill me-3 fs-4 text-success"></i>
                      <div>
                        <h6 class="mb-1 text-success fw-bold">¡Extensión Disponible!</h6>
                        <p class="mb-0 text-muted">Puedes solicitar una extensión hasta 24 horas antes del final.</p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Countdown hasta que se deshabilite -->
                  {% if horas_para_extension and horas_para_extension > 0 %}
                    <div class="text-center mb-3">
                      <div class="d-inline-block p-3 rounded-pill shadow-sm" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <span class="text-white fw-bold" id="countdown-extension">
                          <i class="bi bi-clock me-2"></i>
                          {% if horas_para_extension < 1 %}
                            {{ horas_para_extension|floatformat:0 }} minutos para deshabilitarse
                          {% elif horas_para_extension < 24 %}
                            {{ horas_para_extension|floatformat:0 }} horas para deshabilitarse
                          {% else %}
                            {{ horas_para_extension|floatformat:0 }} horas para deshabilitarse
                          {% endif %}
                        </span>
                      </div>
                    </div>
                  {% endif %}
                  
                  <div class="text-center">
                    <button type="button" class="btn btn-warning btn-lg px-5 py-3 shadow-sm" onclick="solicitarExtension()" style="border-radius: 15px; font-weight: 600;">
                      <i class="bi bi-calendar-plus me-2"></i>
                      Solicitar Extensión
                    </button>
                  </div>
                {% else %}
                  <!-- Estado: No disponible (24 horas o menos) -->
                  <div class="alert alert-danger border-0 mb-3" style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-exclamation-triangle-fill me-3 fs-4 text-danger"></i>
                      <div>
                        <h6 class="mb-1 text-danger fw-bold">Extensión No Disponible</h6>
                        <p class="mb-1">Las extensiones solo se pueden solicitar con más de 24 horas de anticipación.</p>
                        <div class="row mt-2">
                          <div class="col-md-6">
                            <small class="text-muted">
                              <i class="bi bi-calendar-event me-1"></i>
                              <strong>Finalización:</strong> {{ reserva.fecha_fin|date:"d/m/Y H:i" }}
                            </small>
                          </div>
                          <div class="col-md-6">
                            <small class="text-muted">
                              <i class="bi bi-clock me-1"></i>
                              <strong>Límite era:</strong> {{ fecha_disponible_extension|date:"d/m/Y H:i" }}
                            </small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="text-center">
                    <button type="button" class="btn btn-outline-secondary btn-lg px-5 py-3" disabled style="border-radius: 15px; font-weight: 600;">
                      <i class="bi bi-calendar-x me-2"></i>
                      Extensión No Disponible
                      <br>
                      <small class="text-muted">Faltan 24 horas o menos</small>
                    </button>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div>
        <br>
        {% if not is_admin_or_empleado %}
        {% if reserva.inmueble %}
          {% with total_huespedes=huespedes|length %}
            {% if total_huespedes < reserva.cantidad_adultos|add:reserva.cantidad_ninos %}
              <form id="form-huespedes" method="post" action="{% url 'completar_huespedes' reserva.id_reserva %}">
                {% csrf_token %}
                <h5>Completa los datos de los huéspedes antes de pagar</h5>
                {% if reserva.cantidad_adultos > 1 %}
                <h6> Adultos </h6>
                {% for i in rango_adultos %}
                  {% if forloop.counter0 >= 1 %}
                    <div class="row mb-2">
                      <div class="col">
                        <input type="text" name="nombre_{{ forloop.counter0 }}" class="form-control" placeholder="Nombre" required>
                      </div>
                      <div class="col">
                        <input type="text" name="apellido_{{ forloop.counter0 }}" class="form-control" placeholder="Apellido" required>
                      </div>
                      <div class="col">
                        <input type="number" name="dni_{{ forloop.counter0 }}" class="form-control" placeholder="DNI" required>
                      </div>
                      <div class="col">
                        <input type="date" name="fecha_nacimiento_{{ forloop.counter0 }}" class="form-control fecha-adulto" required>
                        <small class="text-muted">Debe ser mayor de 18 años</small>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
                {% endif %}
                {% if reserva.cantidad_ninos > 0 %}
                  <h6> Niños </h6>
                  {% for i in rango_ninos %}
                    <div class="row mb-2">
                      <div class="col">
                        <input type="text" name="nombre_{{ forloop.counter0|add:reserva.cantidad_adultos }}" class="form-control" placeholder="Nombre" required>
                      </div>
                      <div class="col">
                        <input type="text" name="apellido_{{ forloop.counter0|add:reserva.cantidad_adultos }}" class="form-control" placeholder="Apellido" required>
                      </div>
                      <div class="col">
                        <input type="number" name="dni_{{ forloop.counter0|add:reserva.cantidad_adultos }}" class="form-control" placeholder="DNI" required>
                      </div>
                      <div class="col">
                        <input type="date" name="fecha_nacimiento_{{ forloop.counter0|add:reserva.cantidad_adultos }}" class="form-control fecha-nino" required>
                      </div>
                    </div>
                  {% endfor %}
                {% endif %}
                <button type="submit" class="btn btn-primary">Guardar huéspedes</button>
              </form>
            {% endif %}
          {% endwith %}
        {% endif %}
      {% endif %}
    {% endif %}
      {% if reserva.cochera %}
        <div class="mb-3">
          <div class="mt-2">
            <strong>Horarios:</strong> 
            <span class="ms-1">
              {{ reserva.fecha_inicio|time:"H:i" }} - {{ reserva.fecha_fin|time:"H:i" }}
            </span>
          </div>
          {% if reserva.patente %}
            <div class="mt-2">
              <strong>Patente registrada:</strong> {{ reserva.patente }}
            </div>
          {% else %}
            {% if not is_admin_or_empleado %}
              <form method="post" action="{% url 'guardar_patente' reserva.id_reserva %}" class="row g-2 align-items-end" id="form-patente">
                {% csrf_token %}
                <div class="col-auto">
                  <label for="patente" class="form-label mb-0">Patente del vehículo</label>
                  <input type="text" class="form-control" id="patente" name="patente" required maxlength="10" placeholder="ABC123 o AA123BB"
                        value="{{ reserva.patente|default_if_none:'' }}">
                </div>
                <div class="col-auto">
                  <button type="submit" class="btn btn-primary">Guardar patente</button>
                </div>
              </form>
            {% else %}
              <div class="mt-2">
                <strong>Patente:</strong> <em>No registrada</em>
              </div>
            {% endif %}
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
</div>


<!-- ⏱️ TIMER DE PAGO (CONTEO REGRESIVO) -->
{% if tiempo_restante and tiempo_restante > 0 %}
<script>
  let tiempo = Number("{{ tiempo_restante|floatformat:0 }}");
  function actualizarTimer() {
    if (tiempo <= 0) {
      document.getElementById('timer').innerText = "Tiempo agotado";
      const btn = document.getElementById('pagar-btn');
      if (btn) {
        btn.classList.add('disabled');
        btn.setAttribute('aria-disabled', 'true');
        btn.onclick = function(e){ e.preventDefault(); };
      }
      return;
    }
    let horas = Math.floor(tiempo / 3600);
    let minutos = Math.floor((tiempo % 3600) / 60);
    let segundos = Math.floor(tiempo % 60);
    document.getElementById('timer').innerText =
      `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
    tiempo--;
    setTimeout(actualizarTimer, 1000);
  }
  actualizarTimer();
</script>
{% endif %}

<!-- ⏳ CUENTA REGRESIVA PARA SOLICITAR EXTENSIÓN -->
{% if reserva.estado.nombre == 'Confirmada' and not is_admin_or_empleado %}
<script>
  function updateExtensionCountdown() {
    {% if puede_extender and fecha_disponible_extension %}
      const fechaLimite = new Date('{{ fecha_disponible_extension|date:"c" }}');
      const ahora = new Date();
      const diferencia = fechaLimite - ahora;

      const countdownElement = document.getElementById('countdown-extension');
      if (countdownElement) {
        if (diferencia > 0) {
          const horas = Math.floor(diferencia / (1000 * 60 * 60));
          const minutos = Math.floor((diferencia % (1000 * 60 * 60)) / (1000 * 60));
          
          let textoTiempo = '';
          let iconoTiempo = 'bi-clock';
          
          if (horas > 24) {
            const dias = Math.floor(horas / 24);
            const horasRestantes = horas % 24;
            textoTiempo = `${dias}d ${horasRestantes}h para deshabilitarse`;
            iconoTiempo = 'bi-calendar-check';
          } else if (horas > 0) {
            textoTiempo = `${horas}h ${minutos}m para deshabilitarse`;
            iconoTiempo = 'bi-clock';
          } else {
            textoTiempo = `${minutos}m para deshabilitarse`;
            iconoTiempo = 'bi-hourglass-bottom';
          }
          
          countdownElement.innerHTML = `<i class="${iconoTiempo} me-2"></i>${textoTiempo}`;
          
          // Cambiar color según el tiempo restante
          const parent = countdownElement.parentElement;
          if (horas < 1) {
            parent.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
            countdownElement.style.animationDuration = '0.5s';
          } else if (horas < 6) {
            parent.style.background = 'linear-gradient(135deg, #ffc107 0%, #e0a800 100%)';
            countdownElement.style.animationDuration = '1s';
          } else {
            parent.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
            countdownElement.style.animationDuration = '2s';
          }
        } else {
          // Tiempo agotado - la extensión ya no está disponible
          countdownElement.innerHTML = `<i class="bi bi-x-circle-fill me-2"></i>Extensión ya no disponible`;
          countdownElement.parentElement.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
          
          // Recargar después de 3 segundos para mostrar el estado deshabilitado
          setTimeout(() => {
            location.reload();
          }, 3000);
        }
      }
    {% endif %}
  }

  // Ejecutar inmediatamente y cada 30 segundos
  updateExtensionCountdown();
  setInterval(updateExtensionCountdown, 30000);
</script>
{% endif %}

{% block extra_js %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
  // 💡 INICIALIZAR TOOLTIP DE BOOTSTRAP
  document.addEventListener('DOMContentLoaded', function() {
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (el) {
          return new bootstrap.Tooltip(el);
      });
  });

  // ❌ CANCELACIÓN DE RESERVA (ANTES DE PAGO)
  document.addEventListener('DOMContentLoaded', function() {
    const cancelarForm = document.getElementById('cancelarReservaForm');
    if (cancelarForm) {
      cancelarForm.addEventListener('submit', function(e) {
        e.preventDefault();
        Swal.fire({
          title: '¿Seguro que deseas cancelar la reserva?',
          text: "Esta acción no se puede deshacer.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Sí, cancelar',
          cancelButtonText: 'No, volver'
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(this.action, {
              method: 'POST',
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
              }
            })
          })
          .then(res => res.json())
          .then data => {
            if (data.init_point) {
              window.location.href = data.init_point;
            } else {
                Swal.fire({
                  icon: 'success',
                  title: 'Cancelada',
                  text: data.mensaje,
                  timer: 2500,
                  showConfirmButton: false
                }).then(() => {
                  window.location.href = "{% url 'reservas_usuario' %}";
                });
              }
            });
          }
        });
      });
    }
  });

  // ⚠️ CANCELACIÓN DE RESERVA PAGADA (CON POLÍTICA)
  document.addEventListener('DOMContentLoaded', function() {
    const cancelarPagadaForm = document.getElementById('cancelarReservaPagadaForm');
    if (cancelarPagadaForm) {
      cancelarPagadaForm.addEventListener('submit', function(e) {
        e.preventDefault();
        let politicaCancelacion = `{% if reserva.inmueble %}{{ reserva.inmueble.politica_cancelacion|escapejs }}{% elif reserva.cochera %}{{ reserva.cochera.politica_cancelacion|escapejs }}{% endif %}`;
        Swal.fire({
          title: 'Política de Cancelación',
          html: `
            <p><strong>Antes de cancelar:</strong></p>
            <div class="alert alert-info">${politicaCancelacion}</div>
            <p class="text-warning"><strong>Esta acción no se puede deshacer.</strong></p>
          `,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Sí, cancelar reserva',
          cancelButtonText: 'No, mantener reserva'
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(this.action, {
              method: 'POST',
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
              }
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'Reserva Cancelada',
                  text: data.mensaje,
                  timer: 3000,
                  showConfirmButton: false
                }).then(() => {
                  window.location.href = "{% url 'reservas_usuario' %}";
                });
              }
            });
          }
        });
      });
    }
  });

  // 💰 GENERACIÓN DE PAGO CON MERCADOPAGO
  document.addEventListener('DOMContentLoaded', function() {
    const pagarBtn = document.getElementById('pagar-btn');
    if (pagarBtn) {
      pagarBtn.addEventListener('click', function() {
        fetch("{% url 'crear_preferencia_mp' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
          },
          body: JSON.stringify({
            monto: {{ reserva.precio_total }},
            descripcion: "Pago de reserva #{{ reserva.id_reserva }}",
            id_reserva: {{ reserva.id_reserva }}
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.init_point) {
            window.location.href = data.init_point;
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: "Error al generar el pago: " + (data.error || "Error desconocido"),
              timer: 3000,
              showConfirmButton: false
            });
          }
        });
      });
    }
  });

  // 🧍‍♂️ FORMULARIO DE HUÉSPEDES (VALIDACIÓN + GUARDADO)
  document.addEventListener('DOMContentLoaded', function() {
    const form_huespedes = document.getElementById('form-huespedes');
    if (form_huespedes) {
      form_huespedes.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form_huespedes);
        document.querySelectorAll('.error-message').forEach(el => el.remove());
        fetch(form_huespedes.action, {
          method: 'POST',
          headers: {
            'X-CSRFToken': form_huespedes.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            Swal.fire({ icon: 'success', title: data.message || 'Guardado', toast: true, timer: 2000, showConfirmButton: false })
              .then(() => window.location.reload());
          } else if (data.errores) {
            Object.entries(data.errores).forEach(([field, error]) => {
              const input = form_huespedes.querySelector(`[name="${field}"]`);
              if (input) {
                const div = document.createElement('div');
                div.className = 'error-message text-danger mt-1 small';
                div.textContent = error;
                input.parentNode.appendChild(div);
              }
            });
          }
        });
      });
    }
  });

  // 📅 CONFIGURACIÓN DE FLATPICKR PARA FECHAS DE NACIMIENTO
  document.addEventListener('DOMContentLoaded', function() {
    const hoy = new Date();
    const fechaMax = new Date(hoy.getFullYear() - 18, hoy.getMonth(), hoy.getDate());
    const fechaMaxStr = fechaMax.toISOString().split('T')[0];

    flatpickr('.fecha-adulto', {
      dateFormat: "Y-m-d",
      maxDate: fechaMaxStr,
      locale: "es"
    });

    const fechaMaxNino = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
    const fechaMinNino = new Date(hoy.getFullYear() - 18, hoy.getMonth(), hoy.getDate() + 1);
    const fechaMaxNinoStr = fechaMaxNino.toISOString().split('T')[0];
    const fechaMinNinoStr = fechaMinNino.toISOString().split('T')[0];

    flatpickr('.fecha-nino', {
      dateFormat: "Y-m-d",
      minDate: fechaMinNinoStr,
      maxDate: fechaMaxNinoStr,
      locale: "es"
    });
  });

  // 🚗 FORMULARIO PARA GUARDAR PATENTE DE VEHÍCULO
  document.addEventListener('DOMContentLoaded', function() {
    const form_patente = document.getElementById('form-patente');
    if (form_patente) {
      form_patente.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form_patente);
        fetch(form_patente.action, {
          method: 'POST',
          headers: {
            'X-CSRFToken': form_patente.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            Swal.fire({ icon: 'success', title: data.message || 'Patente guardada', toast: true, timer: 2000, showConfirmButton: false })
              .then(() => window.location.reload());
          } else {
            Swal.fire({ icon: 'error', title: 'Error', text: data.error || 'Error al guardar', toast: true, timer: 4000 });
          }
        })
        .catch(() => {
          Swal.fire({ icon: 'error', title: 'Error', text: 'Error en la solicitud', toast: true, timer: 3000 });
        });
      });
    }
  });

  // ➕ FUNCIONALIDAD PARA SOLICITAR EXTENSIÓN DE RESERVA
  function solicitarExtension() {
    Swal.fire({
      title: 'Solicitar Extensión de Reserva',
      html: `
        <div class="text-start">
          <div class="mb-3">
            <label class="form-label">Fecha actual de finalización</label>
            <input type="text" class="form-control" value="{{ reserva.fecha_fin|date:'d/m/Y' }}" readonly>
          </div>
          <div class="mb-3">
            <label for="swal-dias" class="form-label">Días adicionales</label>
            <input type="number" id="swal-dias" class="form-control" min="1" max="7" value="1" required>
            <small class="text-muted">Máximo 7 días</small>
          </div>
          <div class="mb-3">
            <label for="swal-motivo" class="form-label">Motivo de la extensión</label>
            <textarea id="swal-motivo" class="form-control" rows="3" placeholder="Explique por qué necesita extender la reserva"></textarea>
          </div>
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            El costo será calculado automáticamente según los días adicionales.
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'Solicitar Extensión',
      cancelButtonText: 'Cancelar',
      confirmButtonColor: '#0d6efd',
      cancelButtonColor: '#6c757d',
      width: '500px',
      focusConfirm: false,
      preConfirm: () => {
        const dias = document.getElementById('swal-dias').value;
        const motivo = document.getElementById('swal-motivo').value;
        if (!dias || dias < 1 || dias > 7) {
          Swal.showValidationMessage('Los días deben estar entre 1 y 7');
          return false;
        }
        return { dias_extension: dias, motivo: motivo };
      }
    }).then((result) => {
      if (result.isConfirmed) {
        Swal.fire({ title: 'Procesando...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
        fetch("{% url 'solicitar_extension' reserva.id_reserva %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: new URLSearchParams(result.value)
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            Swal.fire({ icon: 'success', title: 'Solicitud enviada', text: 'Será revisada', timer: 3000 })
              .then(() => window.location.reload());
          } else {
            Swal.fire({ icon: 'error', title: 'Error', text: data.error || 'Error desconocido' });
          }
        });
      }
    });
  }
  </script>
{% endblock %} 
{% endblock %}