{% extends 'detalle_base.html' %}
{% load static %}
{% load user_groups %}
{% load dict_extras %}

{% block title %}Detalle del Inmueble - {{ inmueble.nombre }}{% endblock %}

{% block carrusel_imagenes %}
  <div id="inmuebleCarousel" class="carousel slide mb-4 shadow-sm rounded" data-bs-ride="carousel">
    <div class="carousel-inner rounded">
      {% for imagen in inmueble.imagenes.all %}
        <div class="carousel-item {% if forloop.first %}active{% endif %}">
          <img src="{{ imagen.imagen.url }}" class="d-block w-100 img-carrusel-inmueble" alt="{{ inmueble.nombre }}">
        </div>
      {% empty %}
        <div class="carousel-item active">
          <img src="{% static 'img/default-property-large.jpg' %}" class="d-block w-100 img-carrusel-inmueble" alt="Imagen por defecto">
        </div>
      {% endfor %}
    </div>
    {% if inmueble.imagenes.count > 1 %}
      <button class="carousel-control-prev" type="button" data-bs-target="#inmuebleCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#inmuebleCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    {% endif %}
  </div>
{% endblock %}

{% block info_detallada %}
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h1 class="h2 mb-3">{{ inmueble.nombre }}</h1>
      <div class="d-flex align-items-center mb-3">
        <i class="bi bi-geo-alt-fill text-primary me-2"></i>
        <span class="text-muted">
          {{ inmueble.provincia.nombre }}, {{ inmueble.ciudad.nombre }}, {{ inmueble.direccion }}
        </span>
      </div>
      <div class="d-flex flex-wrap gap-3 mb-4">
        <div class="d-flex align-items-center">
          <i class="bi bi-door-open text-primary me-2"></i>
          <span>{{ inmueble.cantidad_ambientes }} ambientes</span>
        </div>
        <div class="d-flex align-items-center">
          <i class="bi bi-bootstrap text-primary me-2"></i>
          <span>{{ inmueble.cantidad_banios }} baño{{ inmueble.cantidad_banios|pluralize }}</span>
        </div>
        <div class="d-flex align-items-center">
          <i class="bi bi-c-square text-primary me-2"></i>
          <span>{{ inmueble.cantidad_camas }} cama{{ inmueble.cantidad_camas|pluralize }}</span>
        </div>
        <div class="d-flex align-items-center">
          <i class="bi bi-people text-primary me-2"></i>
          <span>{{ inmueble.cantidad_huespedes }} huesped{{ inmueble.cantidad_huespedes|pluralize:"es" }}</span>
        </div>
        <div class="d-flex align-items-center">
          <i class="bi bi-calendar-range text-primary me-2"></i>
          <span>Mínimo {{ inmueble.minimo_dias_alquiler }} noche{{ inmueble.minimo_dias_alquiler|pluralize }}</span>
        </div>
        <p class="text-muted small mt-2">
          <i class="bi bi-calendar-date text-primary me-1"></i>
          Publicado el {{ inmueble.fecha_publicacion|date:"d/m/Y" }}
        </p>
        {% if inmueble.inmueble %} {# This condition seems incorrect, as inmueble.inmueble would likely be a recursive reference or always true #}
        <div class="d-flex align-items-center">
          <i class="bi bi-car-front text-primary me-2"></i>
          <span>inmueble</span>
        </div>
        {% endif %}
        {% if inmueble.estado %}
        <span class="badge bg-{% if inmueble.estado.nombre == 'Disponible' %}success{% else %}warning{% endif %}">
          {{ inmueble.estado.nombre }}
        </span>
        {% endif %}
      </div>
      <h3 class="h4 mb-3">Descripción</h3>
      <p class="mb-4">{{ inmueble.descripcion }}</p>
      <h3 class="h4 mb-3">Política de cancelación</h3>
      <p>{{ inmueble.politica_cancelacion }}</p>
    </div>
  </div>
{% endblock %}

{% block sidebar_reserva_o_admin %}
  <div class="card shadow-sm sticky-top" style="top: 20px;">
    <div class="card-body">
      {% if is_admin_or_empleado %}
        <h3 class="h4 mb-3">Gestión del Inmueble</h3>
        <div class="d-flex align-items-end mb-3">
          <span class="h3 text-primary">${{ inmueble.precio_por_dia|floatformat:"0" }}</span>
          <span class="text-muted ms-1">/ noche</span>
        </div>
      {% else %}
        <h3 class="h4 mb-3">Reservar</h3>
        <div class="d-flex align-items-end mb-3">
          <span class="h3 text-primary">${{ inmueble.precio_por_dia|floatformat:"0" }}</span>
          <span class="text-muted ms-1">/ noche</span>
        </div>
        <form method="post" action="{% url 'crear_reserva' id_inmueble=inmueble.id_inmueble %}">
          {% csrf_token %}
          <div class="mb-3">
            <label for="fecha_inicio" class="form-label">Fecha de llegada</label>
            <input type="text" class="form-control" id="fecha_inicio" name="fecha_inicio" required autocomplete="off">
          </div>
          <div class="mb-3">
            <label for="fecha_fin" class="form-label">Fecha de salida</label>
            <input type="text" class="form-control" id="fecha_fin" name="fecha_fin" required autocomplete="off">
          </div>
          <div class="mb-3">
            <ul id="lista-huespedes" class="list-group mb-2" data-max-huespedes="{{ inmueble.cantidad_huespedes }}"></ul>
            <button type="button" class="btn btn-outline-primary btn-sm w-100" id="btn-agregar-huesped">
              <i class="bi bi-person-plus"></i> Agregar huésped
            </button>
          </div>
          <div id="form-huesped" class="card card-body mb-3" style="display:none; max-width: 500px;">
            <div class="mb-3">
              <label for="huesped-nombre" class="form-label">Nombre</label>
              <input type="text" class="form-control" id="huesped-nombre" placeholder="Nombre">
            </div>
            <div class="mb-3">
              <label for="huesped-apellido" class="form-label">Apellido</label>
              <input type="text" class="form-control" id="huesped-apellido" placeholder="Apellido">
            </div>
            <div class="mb-3">
              <label for="huesped-dni" class="form-label">DNI</label>
              <input type="text" class="form-control" id="huesped-dni" placeholder="DNI">
            </div>
            <div class="mb-3">
              <label for="huesped-fecha-nac" class="form-label">Fecha de nacimiento</label>
              <input type="date" class="form-control" id="huesped-fecha-nac" placeholder="Fecha de nacimiento">
            </div>
            <div class="mt-2 text-end">
              <button type="button" class="btn btn-naranja btn-sm" id="btn-aceptar-huesped">Aceptar</button>
              <button type="button" class="btn btn-azul btn-secondary btn-sm" id="btn-cancelar-huesped">Cancelar</button>
            </div>
          </div>
          <input type="hidden" name="huespedes_json" id="huespedes-json">

          <button type="submit" class="btn btn-primary btn-azul w-100 py-2">
            <i class="bi bi-calendar-check me-2"></i> Reservar ahora
          </button>
          <div id="django-messages" style="display: none;">
            {% if messages %}
              {% for message in messages %}
                <div class="django-message" data-tags="{{ message.tags }}" data-message="{{ message }}"></div>
              {% endfor %}
            {% endif %}
          </div>
        </form>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block modal_eliminar %}
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          ¿Estás seguro de que quieres eliminar el inmueble "{{ inmueble.nombre }}"? Esta acción no se puede deshacer.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <form method="post" action="{% url 'admin_inmuebles_eliminar' id_inmueble=inmueble.id_inmueble %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Eliminar</button>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js_custom %}
  <script>
    // Lógica de agregar huésped
    let huespedes = [];
    const maxHuespedes = parseInt(document.getElementById('lista-huespedes').dataset.maxHuespedes);

    // Si hay datos de cliente, precargarlos como primer huésped
    const datosClienteJSON = document.getElementById('datosClienteJSON');
    if (datosClienteJSON && datosClienteJSON.textContent) {
        try {
            const datosCliente = JSON.parse(datosClienteJSON.textContent);
            if (datosCliente.nombre && datosCliente.apellido && datosCliente.dni) {
                huespedes.push(datosCliente);
                actualizarListaHuespedes();
            }
        } catch (e) {
            console.error("Error al parsear datosClienteJSON:", e);
        }
    }


    document.getElementById('btn-agregar-huesped').addEventListener('click', function() {
      if (huespedes.length >= maxHuespedes) {
        Swal.fire({
          position: 'top-end',
          icon: 'warning',
          title: `Ya agregaste el máximo de ${maxHuespedes} huéspedes.`,
          showConfirmButton: false,
          timer: 3000,
          toast: true,
          timerProgressBar: true
        });
        return;
      }
      document.getElementById('form-huesped').style.display = 'block';
      limpiarFormHuesped();
    });

    document.getElementById('btn-cancelar-huesped').addEventListener('click', function() {
      document.getElementById('form-huesped').style.display = 'none';
      limpiarErroresHuesped();
    });

    document.getElementById('btn-aceptar-huesped').addEventListener('click', function() {
      limpiarErroresHuesped();
      const nombre = document.getElementById('huesped-nombre').value.trim();
      const apellido = document.getElementById('huesped-apellido').value.trim();
      const dni = document.getElementById('huesped-dni').value.trim();
      const fechaNac = document.getElementById('huesped-fecha-nac').value;

      let errores = false;
      if (!nombre) { mostrarError('huesped-nombre', 'El nombre es obligatorio.'); errores = true; }
      if (!apellido) { mostrarError('huesped-apellido', 'El apellido es obligatorio.'); errores = true; }
      if (!dni) { mostrarError('huesped-dni', 'El DNI es obligatorio.'); errores = true; }
      if (!fechaNac) { mostrarError('huesped-fecha-nac', 'La fecha de nacimiento es obligatoria.'); errores = true; }

      if (errores) {
        Swal.fire({
          position: 'top-end',
          icon: 'error',
          title: 'Por favor, completa todos los campos del huésped.',
          showConfirmButton: false,
          timer: 3000,
          toast: true,
          timerProgressBar: true
        });
        return;
      }

      const huesped = { nombre, apellido, dni, fecha_nac: fechaNac };
      huespedes.push(huesped);
      actualizarListaHuespedes();
      document.getElementById('form-huesped').style.display = 'none';
      Swal.fire({
        position: 'top-end',
        icon: 'success',
        title: 'Huésped agregado correctamente.',
        showConfirmButton: false,
        timer: 2000,
        toast: true,
        timerProgressBar: true
      });
    });

    function actualizarListaHuespedes() {
      const ul = document.getElementById('lista-huespedes');
      ul.innerHTML = '';
      huespedes.forEach((h, idx) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          ${h.nombre} ${h.apellido} (${h.dni})
          <button type="button" class="btn btn-danger btn-sm" onclick="eliminarHuesped(${idx})">
            <i class="bi bi-x"></i>
          </button>
        `;
        ul.appendChild(li);
      });
      document.getElementById('huespedes-json').value = JSON.stringify(huespedes);

      // Mostrar u ocultar el botón de agregar huésped si se alcanzó el límite
      if (huespedes.length >= maxHuespedes) {
        document.getElementById('btn-agregar-huesped').style.display = 'none';
      } else {
        document.getElementById('btn-agregar-huesped').style.display = 'block';
      }
    }

    // Making this function globally accessible for the onclick event
    window.eliminarHuesped = function(idx) {
      huespedes.splice(idx, 1);
      actualizarListaHuespedes();
      Swal.fire({
        position: 'top-end',
        icon: 'info',
        title: 'Huésped eliminado.',
        showConfirmButton: false,
        timer: 2000,
        toast: true,
        timerProgressBar: true
      });
    }

    function limpiarFormHuesped() {
      document.getElementById('huesped-nombre').value = '';
      document.getElementById('huesped-apellido').value = '';
      document.getElementById('huesped-dni').value = '';
      document.getElementById('huesped-fecha-nac').value = '';
    }

    // Función para mostrar error debajo del campo
    function mostrarError(inputId, mensaje) {
      const input = document.getElementById(inputId);
      if (input && !input.parentNode.querySelector('.error-message')) {
        const errorElement = document.createElement('div');
        errorElement.className = 'error-message text-danger mt-1 small';
        errorElement.textContent = mensaje;
        input.parentNode.appendChild(errorElement);
      }
    }

    // Limpiar errores al modificar un campo
    ['huesped-nombre', 'huesped-apellido', 'huesped-dni', 'huesped-fecha-nac'].forEach(id => {
      const input = document.getElementById(id);
      if (input) {
        input.addEventListener('input', function() {
          const errorElement = this.parentNode.querySelector('.error-message');
          if (errorElement) {
            errorElement.remove();
          }
        });
      }
    });

    function limpiarErroresHuesped() {
      document.querySelectorAll('#form-huesped .error-message').forEach(el => el.remove());
    }
  </script>
{% endblock extra_js_custom %}