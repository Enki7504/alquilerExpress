{% extends 'admin/admin_base.html' %}
{% load static %}

{% block title %}Reservas de la Cochera | Admin{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">Reservas de la Cochera: {{ cochera.nombre }}</h1>
  <a href="{% url 'admin_cocheras' %}" class="btn btn-outline-secondary">Volver</a>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title">Reservas Activas</h5>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Fechas</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for reserva in reservas %}
          <tr>
            <td>{{ reserva.id_reserva }}</td>
            <td>
              {% with relacion=reserva.clientecochera_set.first %}
                {% if relacion and relacion.cliente %}
                  {{ relacion.cliente.usuario.get_full_name|default:relacion.cliente.usuario.username }}
                {% else %}
                  Cliente no disponible
                {% endif %}
              {% endwith %}
            </td>
            <td>{{ reserva.fecha_inicio|date:"d/m/Y" }} - {{ reserva.fecha_fin|date:"d/m/Y" }}</td>
            <td>
              <span class="badge 
                {% if reserva.estado.nombre == 'Confirmada' %}bg-success
                {% elif reserva.estado.nombre == 'Cancelada' %}bg-danger
                {% elif reserva.estado.nombre == 'Rechazada' %}bg-secondary
                {% else %}bg-warning{% endif %}">
                {{ reserva.estado.nombre }}
              </span>
            </td>
            <td>
              {% if reserva.estado.nombre == 'Pendiente' %}
                <button class="btn btn-sm btn-success" onclick="cambiarEstado('{{ reserva.id_reserva }}', 'Aprobada')">Aprobar Solicitud</button>
                <button class="btn btn-sm btn-danger" onclick="cambiarEstado('{{ reserva.id_reserva }}', 'Rechazada')">Rechazar Solicitud</button>
              {% elif reserva.estado.nombre == 'Aprobada' %}
                <button class="btn btn-sm btn-success">Esperando Pago...</button>
              {% elif reserva.estado.nombre == 'Pagada' %}
                <button class="btn btn-sm btn-success" onclick="showConfirmModal('{{ reserva.id_reserva }}', 'Confirmada')">Confirmar Pago</button>
                <button class="btn btn-sm btn-danger" onclick="showConfirmModal('{{ reserva.id_reserva }}', 'Cancelada')">Rechazar Pago</button>
              {% elif reserva.estado.nombre == 'Confirmada' %}
                <button class="btn btn-sm btn-danger" onclick="showConfirmModal('{{ reserva.id_reserva }}', 'Cancelada')">Cancelar Alquiler</button>
              {% endif %}
              <a href="{% url 'detalle_cochera' cochera.id_cochera %}" class="btn btn-sm btn-info">Ver Cochera</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center">No hay reservas activas</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="confirmationModal" class="modal" tabindex="-1" role="dialog" style="display: none;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Acción</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="hideConfirmModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="confirmationMessage"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="hideConfirmModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" id="confirmActionButton">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<div id="inputModal" class="modal" tabindex="-1" role="dialog" style="display: none;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ingrese Comentario</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="hideInputModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Ingrese un comentario (opcional):</p>
        <input type="text" class="form-control" id="commentInput">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="hideInputModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" id="inputSubmitButton">Enviar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function cambiarEstado(reservaId, nuevoEstado) {
  Swal.fire({
    title: `¿Estás seguro de cambiar el estado a ${nuevoEstado}?`,
    input: 'text',
    inputLabel: 'Comentario (opcional)',
    inputPlaceholder: 'Ingrese un comentario',
    showCancelButton: true,
    confirmButtonText: 'Confirmar',
    cancelButtonText: 'Cancelar',
    icon: 'question',
    preConfirm: (comentario) => {
      return fetch(
        window.location.pathname.includes('cochera')
          ? `/panel/reserva-cochera/${reservaId}/cambiar-estado/`
          : `/panel/reserva-inmueble/${reservaId}/cambiar-estado/`,
        {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            estado: nuevoEstado,
            comentario: comentario
          })
        }
      )
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'Error al actualizar el estado');
          });
        }
        return response.json();
      })
      .catch(error => {
        Swal.showValidationMessage(error.message || 'Error al actualizar el estado');
      });
    }
  }).then((result) => {
    if (result.isConfirmed) {
      Swal.fire({
        icon: 'success',
        title: 'Estado actualizado',
        showConfirmButton: false,
        timer: 1500,
        toast: true,
        position: 'top-end'
      }).then(() => {
        location.reload();
      });
    }
  });
}
</script>
{% endblock %}